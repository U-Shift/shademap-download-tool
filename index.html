<!DOCTYPE html>
<html>

<head>
    <title>ShadeMap download tool</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="./css/index.css" />
</head>

</head>

<body>
    <div id='map'></div>

    <div id='loader'>
        <p>0%</p>
        <progress value="0" max="100"></progress>
        <small></small>
    </div>

    <div id='panel' class="hidden">
        <article>
            <header>
                <div style="display: flex; flex-direction: row; flex-wrap: nowrap;">
                    <h4 style="margin: 0;">üó∫Ô∏è ShadeMap download tool</h4>
                    <small style="margin-left: auto;"><a href="#" class="help-modal">‚ÑπÔ∏è Help</a> <a href="#"
                            class="about-modal">üèõÔ∏è About</a></small>
                </div>
                <small>
                    Loading map...
                </small>
            </header>

            <div id="form" class="hidden" style="display: none;">
                <!-- Common parameters-->
                <div>
                    <small>North-West corner coordinates (latitude, longitude)</small>
                    <fieldset role="group">
                        <input type="number" name="number" id="nw-lat" placeholder="Latitude">
                        <input type="number" name="number" id="nw-lon" placeholder="Longitude">
                    </fieldset>
                </div>

                <div>
                    <small>Shouth-East corner coordinates (latitude, longitude)</small>
                    <fieldset role="group">
                        <input type="number" name="number" id="se-lat" placeholder="Latitude">
                        <input type="number" name="number" id="se-lon" placeholder="Longitude">
                    </fieldset>
                </div>

                <div>
                    <small>Date(s) to consider (YYYY-MM-DD, separated by comma)</small>
                    <input type="text" id="dates" placeholder="YYYY-MM-DD">
                </div>

                <div>
                    <fieldset role="group">
                        <div>
                            <small>File name (defaults to stitch)</small>
                            <input type="text" id="filename" placeholder="Default: stitch">
                        </div>
                        <div>
                            <small>Zoom level</small>
                            <input type="number" name="number" id="zoom" placeholder="Default: 15">
                        </div>
                    </fieldset>
                </div>

                <!-- Layer specific forms-->
                <details name="layer" id="layer-shadow" open>
                    <summary>üåá Shadows</summary>

                    <div>
                        <small>Hour(s) to consider (UTC) (HH:MM, separated by comma)</small>
                        <input type="text" id="hours" placeholder="HH:MM">
                    </div>


                </details>

                <hr />

                <details name="layer" id="layer-sun">
                    <summary>‚òÄÔ∏è Sun exposure</summary>
                    <div>
                        <small>Interval to consider (UTC) (HH:MM)</small>
                        <fieldset role="group">
                            <input type="text" id="hour-start" placeholder="Start (HH:MM)">
                            <input type="text" id="hour-end" placeholder="End (HH:MM)">
                        </fieldset>
                    </div>

                    <div>
                        <small>Iterations (see help for ‚ÑπÔ∏è)</small>
                        <input type="number" id="iterations" placeholder="Default: 32">
                    </div>
                </details>

                <footer style="padding-top: 32px;">
                    <div role="group">
                        <button id="download" disabled>Loading map...</button>
                    </div>
                </footer>
            </div>
        </article>
    </div>


    <dialog open id="modal-keys">
        <article>
            <header>
                <div style="display: flex; flex-direction: row; flex-wrap: nowrap;">
                    <h4 style="margin: 0;">üó∫Ô∏è ShadeMap download tool</h4>
                    <small style="margin-left: auto;"><a href="#" class="help-modal">‚ÑπÔ∏è Help</a> <a href="#"
                            class="about-modal">üèõÔ∏è About</a></small>
                </div>
            </header>
            <p>
                Welcome! This tool uses Mapbox and ShadeMap services, for which you need to provide API keys. <u>You can
                    create them for free</u>.
            </p>

            <small><a href="https://docs.mapbox.com/help/getting-started/access-tokens/" target="_blank">Mapbox API key
                    tutorial</a></small>
            <br />
            <small><a href="https://shademap.app/about/#" target="_blank">Shademap API key page</a> (click on "Get API
                key", it will be sent to your email)</small>

            <hr />

            <div>
                <div>
                    <small>Mapbox API key (default public token)</small>
                    <input type="text" id="key-mapbox" placeholder="Your API key">
                </div>

                <div>
                    <small>Shademap API key</small>
                    <input type="text" id="key-shademap" placeholder="Your API key">
                </div>

                <label>
                    <input type="checkbox" name="save-keys" checked />
                    Save on local storage, to avoid filling them again <br /><small>(nothing will be sent to our
                        server)</small>
                </label>
            </div>

            <footer>
                <div role="group">
                    <button id="key-validation">Proceed</button>
                </div>
            </footer>
        </article>
    </dialog>

    <dialog open id="modal-help" class="hidden">
        <article>
            <header>
                <h4>
                    <strong>‚ÑπÔ∏è Help</strong>
                </h4>
            </header>

            <h5>Form</h5>
            <dl>
                <dt>
                    <b>What are the NW and SE coordinates for?</b>
                </dt>
                <dd>
                    The export is generated over a square area, defined with the north-west and south-east corners
                    coordinates, for a specic date and time, with the level of detail specified by the zoom level.
                </dd>
            </dl>
            <dl>
                <dt>
                    <b>What are the iteractions parameter, on the sun exposure form?</b>
                </dt>
                <dd>
                    According to the ShadeMap documentation: "Number of discrete chunks to calculate shadows for between
                    startDate and endDate. A larger number will provide more detail but take longer to compute."
                </dd>
            </dl>

            <h5>File export</h5>
            <dl>
                <dt>
                    <b>What is the coordinate reference of the file generated? </b>
                </dt>
                <dd>
                    The file is generated according to the WGS 84 coordinate reference system (EPSG:4326).
                </dd>
            </dl>
            <dl>
                <dt>
                    <b>How can I interpret the values of the file generated?</b>
                </dt>
                <dd>
                    <ul>
                        <li>Shadows are exported in a binary system: 0 for shadows, 255 for sun.</li>
                        <li>Sun light exposure values range from 0 to 240, and can be converted to the total minutes of
                            sun exposure by multiplying this value by 6.</li>
                    </ul>
                </dd>

            </dl>

            <h5>Privacy</h5>
            <dl>
                <dt>
                    <b>Is it safe to check the box to store the API credentials? </b>
                </dt>
                <dd>
                    The API key is stored on the local storage of your browser, in plain text. It is not sent to other
                    services rather than the Mapbox and ShadeMap APIs. The APIs are accessed directly from your browser,
                    without any brokers.
                </dd>
            </dl>
            <dl>
                <dt>
                    <b>Can I delete the credentials, once stored?</b>
                </dt>
                <dd>
                    Yes, just reload the page, and enter the application again, but this time unchecking the box to save
                    credentials. Once you access after this, they will be removed.
                </dd>
            </dl>

            <footer>
                <div role="group">
                    <button class="secondary outline modal-close">Go back</button>
                </div>
            </footer>
        </article>
    </dialog>

    <dialog open id="modal-about" class="hidden">
        <article>
            <header>
                <h4>
                    <strong>üèõÔ∏è About</strong>
                </h4>
            </header>

            <p>
                This web app is an adaptation of Ted Piotrowski's work, which provides example scripts to export
                ShadeMap data.
            </p>
            <a href="https://github.com/ted-piotrowski/shademap-examples" target="_blank">Original GitHub project</a>
            <br /><br />

            <p>
                The "üó∫Ô∏è ShadeMap download tool" is an extension to this work, adapting it to provide an user interface
                that allows a smooth experience through the browser, without editting any code, introducing also some
                new features.
            </p>
            <a href="https://github.com/gmatosferreira/shademap-examples" target="_blank">ShadeMap download tool GitHub
                project</a>

            <br /><br />
            <p>
                Developed by <a href="https://ushift.tecnico.ulisboa.pt" target="_blank">U-shift</a>, a research group
                from Instituto Superior T√©cnico, Lisboa, Portugal.
            </p>

            <footer>
                <div role="group">
                    <button class="secondary outline modal-close">Go back</button>
                </div>
            </footer>
        </article>
    </dialog>
    <dialog open id="modal-success" class="hidden">
        <article>
            <h4>‚úÖ Success!</h4>
            <p></p>
            <footer>
                <div role="group">
                    <button class="secondary outline modal-close">Go back to form</button>
                </div>
            </footer>
        </article>
    </dialog>

    <dialog open id="modal-error" class="hidden">
        <article>
            <h4>‚ö†Ô∏è There was an error!</h4>
            <p></p>
            <footer>
                <div role="group">
                    <button class="secondary outline modal-close">Go back to form</button>
                </div>
            </footer>
        </article>
    </dialog>
</body>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src='https://www.unpkg.com/mapbox-gl-shadow-simulator/dist/mapbox-gl-shadow-simulator.umd.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>

<script src="js/sm_utils.js"></script>
<script src="js/utils.js"></script>
<script src="js/main.js"></script>

</html>
